<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>من المجرم المطلوب</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            transition: background 0.5s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .game-title {
            text-align: center;
            color: white;
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .welcome-screen {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            text-align: right;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-join {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .btn-join:hover {
            background: linear-gradient(45deg, #218838, #1ba085);
        }

        .btn-create {
            background: linear-gradient(45deg, #007bff, #6610f2);
        }

        .btn-create:hover {
            background: linear-gradient(45deg, #0056b3, #520dc2);
        }

        .btn-default {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }

        .btn-default:hover {
            background: linear-gradient(45deg, #5a6fd8, #6a4190);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #e83e8c);
        }

        .btn-danger:hover {
            background: linear-gradient(45deg, #c82333, #d91a72);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #17a2b8);
        }

        .btn-success:hover {
            background: linear-gradient(45deg, #218838, #138496);
        }

        .room-info {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
        }

        .room-code {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
            letter-spacing: 5px;
        }

        .room-link {
            background: #e9ecef;
            padding: 15px;
            border-radius: 10px;
            word-break: break-all;
            margin: 15px 0;
            font-family: monospace;
        }

        .players-list {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .player-item {
            background: #f8f9fa;
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 8px;
            border-right: 4px solid #667eea;
        }

        .team-selection {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .team-box {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 10px;
            flex: 1;
            min-width: 250px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .team-red {
            border-top: 5px solid #dc3545;
        }

        .team-blue {
            border-top: 5px solid #007bff;
        }

        .team-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .red-team { color: #dc3545; }
        .blue-team { color: #007bff; }

        .role-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .role-btn {
            padding: 12px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .role-btn:hover {
            background: #f8f9fa;
        }

        .role-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .game-area {
            display: none;
        }

        .game-header {
            text-align: center;
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .turn-indicator {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .selection-count {
            font-size: 1.2rem;
            color: #666;
        }

        .criminals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .criminal-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            cursor: pointer;
        }

        .criminal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .criminal-card.selected {
            border: 3px solid #28a745;
            background: #f8fff9;
        }

        .criminal-card.target {
            border: 3px solid #dc3545 !important;
            background: #fff5f5 !important;
        }

        .criminal-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 15px;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #666;
        }

        .criminal-name {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .select-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .select-btn:hover {
            background: #218838;
            transform: scale(1.1);
        }

        .voters-list {
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
            min-height: 20px;
        }

        .teams-display {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            gap: 20px;
        }

        .team-display {
            flex: 1;
            background: white;
            border-radius: 15px;
            padding: 20px;
        }

        .team-display.red {
            border-right: 5px solid #dc3545;
        }

        .team-display.blue {
            border-right: 5px solid #007bff;
        }

        .game-controls {
            text-align: center;
            margin: 30px 0;
        }

        .witness-controls {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .witness-btn {
            background: #f39c12;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 16px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .witness-btn:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .victory-screen {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .certificate {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .hidden {
            display: none !important;
        }

        .red-turn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%) !important;
        }

        .blue-turn {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%) !important;
        }

        @media (max-width: 768px) {
            .game-title {
                font-size: 2rem;
            }
            
            .criminals-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }
            
            .teams-display {
                flex-direction: column;
            }
            
            .team-selection {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="game-title">🕵️ من المجرم المطلوب 🔍</h1>

        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="welcome-screen">
            <div class="input-group">
                <label for="playerName">اسم اللاعب</label>
                <input type="text" id="playerName" placeholder="أدخل اسمك">
            </div>
            
            <div class="input-group">
                <label for="roomCode">رمز الغرفة</label>
                <input type="text" id="roomCode" placeholder="أدخل رمز الغرفة للانضمام">
            </div>
            
            <button class="btn btn-join" onclick="joinRoom()">انضمام للغرفة</button>
            <button class="btn btn-create" onclick="createRoom()">إنشاء غرفة جديدة</button>
        </div>

        <!-- Room Screen -->
        <div id="roomScreen" class="hidden">
            <div class="room-info">
                <h2>غرفة اللعب</h2>
                <div class="room-code" id="displayRoomCode"></div>
                <div class="room-link" id="roomLink"></div>
                <button class="btn btn-default" onclick="copyRoomLink()">نسخ الرابط</button>
            </div>

            <div class="players-list">
                <h3>اللاعبون المتصلون</h3>
                <div id="playersList"></div>
                <button class="btn btn-success" id="startGameBtn" onclick="startGame()" style="display: none;">بدء اللعبة</button>
            </div>

            <button class="btn btn-danger" onclick="leaveRoom()">مغادرة الغرفة</button>
        </div>

        <!-- Team Selection Screen -->
        <div id="teamScreen" class="hidden">
            <!-- Criminal Display -->
            <div class="team-box" style="background: linear-gradient(45deg, #ff6b6b, #ee5a52); color: white; margin-bottom: 30px;">
                <div class="team-title" style="color: white;">🔴 المجرم المطلوب 🔴</div>
                <div id="criminalName" style="font-size: 2rem; font-weight: bold; margin: 15px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">لم يتم اختيار المجرم بعد</div>
                <div id="criminalMessage" style="font-size: 1.2rem; margin: 10px 0; font-weight: bold;">سيتم اختيار المجرم عشوائياً من اللاعبين</div>
                <div style="font-size: 1rem; margin-top: 15px; background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px;">
                    ⚠️ المجرم لا يمكنه الانضمام لأي فريق - سيلعب ضد الجميع
                </div>
            </div>

            <div class="team-selection">
                <div class="team-box team-red">
                    <div class="team-title red-team">الفريق الأحمر</div>
                    <div class="role-buttons">
                        <button class="role-btn" data-team="red" data-role="detective" onclick="selectRole('red', 'detective')">محقق</button>
                        <button class="role-btn" data-team="red" data-role="witness" onclick="selectRole('red', 'witness')">شاهد عيان</button>
                    </div>
                    <div id="redTeamMembers"></div>
                </div>

                <div class="team-box team-blue">
                    <div class="team-title blue-team">الفريق الأزرق</div>
                    <div class="role-buttons">
                        <button class="role-btn" data-team="blue" data-role="detective" onclick="selectRole('blue', 'detective')">محقق</button>
                        <button class="role-btn" data-team="blue" data-role="witness" onclick="selectRole('blue', 'witness')">شاهد عيان</button>
                    </div>
                    <div id="blueTeamMembers"></div>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="btn btn-default" id="readyBtn" onclick="playerReady()" style="display: none;">جاهز للعب</button>
                <button class="btn btn-success" id="startGameBtn2" onclick="startActualGame()" style="display: none;">بدء اللعبة</button>
            </div>
        </div>

        <!-- Criminal Position Selection -->
        <div id="criminalSelectionScreen" class="game-area hidden">
            <div class="game-header">
                <div class="turn-indicator">اختر موقعك في البطاقات</div>
                <div class="selection-count">انقر على البطاقة التي تريد أن تكون فيها</div>
                <div style="color: #dc3545; font-weight: bold; margin-top: 10px;">
                    عدد مرات التغيير المتبقية: <span id="movesLeft">2</span>
                </div>
            </div>

            <div class="criminals-grid" id="criminalPositionGrid"></div>

            <div class="game-controls">
                <button class="btn btn-success" id="confirmPositionBtn" onclick="confirmCriminalPosition()" style="display: none;">تأكيد الموقع</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="game-area hidden">
            <div class="game-header">
                <div class="turn-indicator" id="turnIndicator">دور الفريق الأحمر</div>
                <div class="selection-count" id="selectionCount">اختر 5 مشتبه بهم</div>
            </div>

            <!-- Criminal Controls -->
            <div id="criminalControls" class="witness-controls hidden" style="background: #ffebee; border-color: #f8bbd9;">
                <h3>🔴 أنت المجرم المطلوب</h3>
                <p>موقعك الحالي: <span id="currentPosition"></span></p>
                <p>مرات التغيير المتبقية: <span id="remainingMoves">2</span></p>
                <button class="witness-btn" id="changePosBtn" onclick="changeCriminalPosition()" style="background: #dc3545;">تغيير الموقع</button>
            </div>

            <div class="teams-display">
                <div class="team-display red">
                    <h3 class="red-team">الفريق الأحمر</h3>
                    <div id="redTeamDisplay"></div>
                </div>
                <div class="team-display blue">
                    <h3 class="blue-team">الفريق الأزرق</h3>
                    <div id="blueTeamDisplay"></div>
                </div>
            </div>

            <div class="criminals-grid" id="criminalsGrid"></div>

            <div class="game-controls">
                <button class="btn btn-default" id="finishTurnBtn" onclick="finishTurn()">إنهاء الدور</button>
            </div>

            <div id="witnessControls" class="witness-controls hidden">
                <h3>شاهد العيان - هل المجرم ضمن المحددين؟</h3>
                <button class="witness-btn" onclick="witnessResponse(true)">نعم، ضمن المحددين</button>
                <button class="witness-btn" onclick="witnessResponse(false)">لا، ليس ضمن المحددين</button>
            </div>
        </div>

        <!-- Victory Screen -->
        <div id="victoryScreen" class="hidden">
            <div class="victory-screen">
                <h2>🎉 تهانينا! 🎉</h2>
                <div class="certificate">
                    <h3>شهادة تقدير من المحكمة العليا</h3>
                    <p>يُشهد بأن فريق <span id="winningTeam"></span> قد نجح في القبض على المجرم المطلوب</p>
                    <p>وأظهر مهارات تحقيقية متميزة</p>
                </div>
                <button class="btn btn-success" onclick="newGame()">لعبة جديدة</button>
                <button class="btn btn-danger" onclick="leaveRoom()">مغادرة الغرفة</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAcIwwapktH2nxyZczVKFacTrLh1o-EgdM",
            authDomain: "shakkak-8f90f.firebaseapp.com",
            databaseURL: "https://shakkak-8f90f-default-rtdb.firebaseio.com",
            projectId: "shakkak-8f90f",
            storageBucket: "shakkak-8f90f.firebasestorage.app",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:ed874a451b37fb3210f773",
            measurementId: "G-QRH0Z1HM5R"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            var database = firebase.database();
        } catch (error) {
            console.error("خطأ في تهيئة Firebase:", error);
        }

        // Game State
        let currentRoom = null;
        let currentPlayer = null;
        let gameState = {
            phase: 'waiting', // waiting, teams, criminalSelection, playing, witness, victory
            currentTeam: 'red',
            round: 1,
            maxSelections: 5,
            selectedCriminals: [],
            targetCriminal: null,
            criminal: null,
            criminalPosition: null,
            criminalMoves: 2,
            teams: {
                red: { detectives: [], witness: null },
                blue: { detectives: [], witness: null }
            }
        };

        // Criminal names
        const criminals = [
            'أحمد المشبوه', 'سارة الغامضة', 'محمد الخطير', 'فاطمة المجهولة', 'علي المطلوب',
            'نور المختفية', 'حسن المراوغ', 'ليلى الماكرة', 'عمر الهارب', 'زينب المتخفية'
        ];

        function generateRoomCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        function createRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                console.error('يرجى إدخال اسم اللاعب');
                return;
            }

            currentRoom = generateRoomCode();
            currentPlayer = { name: playerName, isHost: true };

            const roomData = {
                host: playerName,
                players: { [playerName]: { name: playerName, isHost: true, ready: false } },
                gameState: gameState,
                createdAt: Date.now()
            };

            database.ref('rooms/' + currentRoom).set(roomData).then(() => {
                showRoomScreen();
                listenToRoom();
            }).catch(error => {
                console.error("خطأ في إنشاء الغرفة:", error);
            });
        }

        function joinRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();

            if (!playerName || !roomCode) {
                console.error('يرجى إدخال اسم اللاعب ورمز الغرفة');
                return;
            }

            database.ref('rooms/' + roomCode).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    currentRoom = roomCode;
                    currentPlayer = { name: playerName, isHost: false };

                    database.ref('rooms/' + currentRoom + '/players/' + playerName).set({
                        name: playerName,
                        isHost: false,
                        ready: false
                    }).then(() => {
                        showRoomScreen();
                        listenToRoom();
                    }).catch(error => {
                        console.error("خطأ في الانضمام للغرفة:", error);
                    });
                } else {
                    console.error('الغرفة غير موجودة');
                }
            }).catch(error => {
                console.error("خطأ في التحقق من وجود الغرفة:", error);
            });
        }

        function showRoomScreen() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('roomScreen').classList.remove('hidden');
            
            document.getElementById('displayRoomCode').textContent = currentRoom;
            document.getElementById('roomLink').textContent = `https://shakkakk.github.io/mnomjrm/?room=${currentRoom}`;
            
            if (currentPlayer.isHost) {
                document.getElementById('startGameBtn').style.display = 'block';
            }
        }

        function copyRoomLink() {
            const link = document.getElementById('roomLink').textContent;
            const tempInput = document.createElement('input');
            tempInput.value = link;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            console.log('تم نسخ الرابط');
        }

        function listenToRoom() {
            database.ref('rooms/' + currentRoom).on('value', (snapshot) => {
                const roomData = snapshot.val();
                if (!roomData) {
                    leaveRoom(); // If room is deleted, leave
                    return;
                }

                updatePlayersList(roomData.players);
                
                if (roomData.gameState) {
                    gameState = roomData.gameState;
                    updateGameDisplay();
                }
            });
        }

        function updatePlayersList(players) {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';
            
            if (players) {
                Object.values(players).forEach(player => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'player-item';
                    playerDiv.textContent = player.name + (player.isHost ? ' (المضيف)' : '');
                    playersList.appendChild(playerDiv);
                });
            }
        }

        function startGame() {
            if (!currentPlayer.isHost) return;

            // Get the latest game state from the database
            database.ref('rooms/' + currentRoom + '/gameState').once('value').then(gameStateSnapshot => {
                const currentGameState = gameStateSnapshot.val() || {};
                
                database.ref('rooms/' + currentRoom + '/players').once('value').then((playersSnapshot) => {
                    const players = playersSnapshot.val();
                    const playerNames = players ? Object.keys(players) : [];
                    
                    if (playerNames.length === 0) {
                        console.error('لا يوجد لاعبون في الغرفة!');
                        return;
                    }

                    const randomIndex = Math.floor(Math.random() * playerNames.length);
                    
                    const newGameState = {
                        ...currentGameState,
                        criminal: playerNames[randomIndex],
                        phase: 'teams',
                        targetCriminal: null,
                        // --- FIX: Ensure teams object is always present ---
                        teams: currentGameState.teams || {
                            red: { detectives: [], witness: null },
                            blue: { detectives: [], witness: null }
                        }
                    };
                    
                    database.ref('rooms/' + currentRoom + '/gameState').set(newGameState).catch(error => {
                        console.error("خطأ في بدء اللعبة:", error);
                    });
                });
            });
        }

        function selectRole(team, role) {
            if (gameState.phase !== 'teams') return;
            if (gameState.criminal === currentPlayer.name) {
                console.error('المجرم لا يمكنه الانضمام لأي فريق!');
                return;
            }

            // Get the latest teams data from the database
            database.ref('rooms/' + currentRoom + '/gameState/teams').once('value').then(teamsSnapshot => {
                // --- FIX: Use a robust default if teams is undefined, which causes the error ---
                const updatedTeams = teamsSnapshot.val() || {
                    red: { detectives: [], witness: null },
                    blue: { detectives: [], witness: null }
                };
                
                // --- FIX: Correctly clear the player from all roles before assigning a new one ---
                const playerName = currentPlayer.name;

                // Remove player from any other team/role
                if (updatedTeams.red) {
                    // FIX: Ensure detectives is an array before calling filter
                    if (Array.isArray(updatedTeams.red.detectives)) {
                        updatedTeams.red.detectives = updatedTeams.red.detectives.filter(p => p !== playerName);
                    }
                    if (updatedTeams.red.witness === playerName) {
                        updatedTeams.red.witness = null;
                    }
                }
                
                if (updatedTeams.blue) {
                    // FIX: Ensure detectives is an array before calling filter
                    if (Array.isArray(updatedTeams.blue.detectives)) {
                        updatedTeams.blue.detectives = updatedTeams.blue.detectives.filter(p => p !== playerName);
                    }
                    if (updatedTeams.blue.witness === playerName) {
                        updatedTeams.blue.witness = null;
                    }
                }

                // Add player to the new team/role
                if (role === 'detective') {
                    // --- FIX: Ensure the detectives array exists ---
                    if (!updatedTeams[team].detectives) {
                        updatedTeams[team].detectives = [];
                    }
                    updatedTeams[team].detectives.push(playerName);
                } else if (role === 'witness') {
                    updatedTeams[team].witness = playerName;
                }
                
                // Update database with the modified teams object
                database.ref('rooms/' + currentRoom + '/gameState/teams').set(updatedTeams).catch(error => {
                    console.error("خطأ في اختيار الدور:", error);
                });
            });
        }

        function playerReady() {
            database.ref('rooms/' + currentRoom + '/players/' + currentPlayer.name + '/ready').set(true);
        }

        function startActualGame() {
            if (!currentPlayer.isHost) return;
            
            database.ref('rooms/' + currentRoom + '/gameState').once('value').then(gameStateSnapshot => {
                const currentGameState = gameStateSnapshot.val() || {};
                const newGameState = {
                    ...currentGameState,
                    phase: 'criminalSelection',
                    criminalPosition: null,
                    criminalMoves: 2
                };
                
                database.ref('rooms/' + currentRoom + '/gameState').set(newGameState).catch(error => {
                    console.error("خطأ في بدء اللعبة الفعلية:", error);
                });
            });
        }

        function updateGameDisplay() {
            // Check current player role and phase to decide which screen to show
            if (gameState.phase === 'waiting') {
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('roomScreen').classList.remove('hidden');
            } else if (gameState.phase === 'teams') {
                showTeamScreen();
            } else if (gameState.phase === 'criminalSelection') {
                showCriminalSelectionScreen();
            } else if (gameState.phase === 'playing' || gameState.phase === 'witness') {
                showGameScreen();
            } else if (gameState.phase === 'victory') {
                showVictoryScreen();
            }
        }

        function showCriminalSelectionScreen() {
            document.getElementById('teamScreen').classList.add('hidden');
            document.getElementById('criminalSelectionScreen').classList.remove('hidden');
            
            if (gameState.criminal === currentPlayer.name) {
                createCriminalPositionGrid();
            } else {
                document.getElementById('criminalSelectionScreen').innerHTML = `
                    <div class="game-header">
                        <div class="turn-indicator">انتظار المجرم لاختيار موقعه</div>
                        <div class="selection-count">${gameState.criminal} يختار موقعه في البطاقات</div>
                    </div>
                    <div style="text-align: center; margin-top: 50px;">
                        <p>يرجى الانتظار بينما يقوم المجرم باختيار موقعه السري.</p>
                    </div>
                `;
            }
        }

        function createCriminalPositionGrid() {
            const grid = document.getElementById('criminalPositionGrid');
            grid.innerHTML = '';
            
            criminals.forEach((name, index) => {
                const card = document.createElement('div');
                card.className = 'criminal-card';
                card.dataset.index = index;
                
                if (gameState.criminalPosition === index) {
                    card.classList.add('selected');
                }
                
                card.innerHTML = `
                    <div class="criminal-image">👤</div>
                    <div class="criminal-name">${name}</div>
                `;
                
                card.addEventListener('click', () => selectCriminalPosition(index));
                grid.appendChild(card);
            });
            
            document.getElementById('movesLeft').textContent = gameState.criminalMoves;
            document.getElementById('confirmPositionBtn').style.display = gameState.criminalPosition !== null ? 'block' : 'none';
        }

        function selectCriminalPosition(index) {
            if (gameState.criminal !== currentPlayer.name) return;
            
            // Clear previous selection
            document.querySelectorAll('.criminal-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Select new position
            gameState.criminalPosition = index;
            document.querySelector(`#criminalPositionGrid [data-index="${index}"]`).classList.add('selected');
            document.getElementById('confirmPositionBtn').style.display = 'block';
        }

        function confirmCriminalPosition() {
            if (gameState.criminal !== currentPlayer.name || gameState.criminalPosition === null) return;
            
            database.ref('rooms/' + currentRoom + '/gameState').once('value').then(gameStateSnapshot => {
                const currentGameState = gameStateSnapshot.val() || {};
                const newGameState = {
                    ...currentGameState,
                    phase: 'playing',
                    targetCriminal: currentGameState.criminalPosition,
                    teams: currentGameState.teams || {
                        red: { detectives: [], witness: null },
                        blue: { detectives: [], witness: null }
                    }
                };
                
                database.ref('rooms/' + currentRoom + '/gameState').set(newGameState).catch(error => {
                    console.error("خطأ في تأكيد موقع المجرم:", error);
                });
            });
        }

        function changeCriminalPosition() {
            if (gameState.criminal !== currentPlayer.name || gameState.criminalMoves <= 0) return;
            
            database.ref('rooms/' + currentRoom + '/gameState').once('value').then(gameStateSnapshot => {
                const currentGameState = gameStateSnapshot.val() || {};
                const newMoves = currentGameState.criminalMoves - 1;

                const grid = document.getElementById('criminalsGrid');
                const cards = grid.querySelectorAll('.criminal-card');
                
                cards.forEach((card, index) => {
                    if (index !== currentGameState.criminalPosition) {
                        card.style.border = '3px dashed #28a745';
                        card.style.cursor = 'pointer';
                        card.onclick = () => {
                            const newGameState = {
                                ...currentGameState,
                                criminalPosition: index,
                                targetCriminal: index,
                                criminalMoves: newMoves
                            };
                            
                            cards.forEach(c => {
                                c.style.border = '';
                                c.style.cursor = '';
                                c.onclick = null;
                            });
                            
                            database.ref('rooms/' + currentRoom + '/gameState').set(newGameState).catch(error => {
                                console.error("خطأ في تغيير موقع المجرم:", error);
                            });
                            updateCriminalControls();
                        };
                    }
                });
            });
        }

        function updateCriminalControls() {
            if (gameState.criminal === currentPlayer.name) {
                document.getElementById('criminalControls').classList.remove('hidden');
                document.getElementById('currentPosition').textContent = criminals[gameState.criminalPosition];
                document.getElementById('remainingMoves').textContent = gameState.criminalMoves;
                
                const changePosBtn = document.getElementById('changePosBtn');
                if (gameState.criminalMoves <= 0) {
                    changePosBtn.disabled = true;
                    changePosBtn.textContent = 'لا توجد حركات متبقية';
                    changePosBtn.style.background = '#6c757d';
                } else {
                    changePosBtn.disabled = false;
                    changePosBtn.textContent = 'تغيير الموقع';
                    changePosBtn.style.background = '#dc3545';
                }
            } else {
                document.getElementById('criminalControls').classList.add('hidden');
            }
        }

        function showTeamScreen() {
            document.getElementById('roomScreen').classList.add('hidden');
            document.getElementById('teamScreen').classList.remove('hidden');
            
            updateTeamDisplay();
        }

        function updateTeamDisplay() {
            const redMembers = document.getElementById('redTeamMembers');
            const blueMembers = document.getElementById('blueTeamMembers');
            const criminalName = document.getElementById('criminalName');

            // --- إصلاح مشكلة عدم عرض اسم المجرم ---
            if (gameState.criminal) {
                criminalName.textContent = `👤 ${gameState.criminal}`;
                if (currentPlayer && gameState.criminal === currentPlayer.name) {
                    document.getElementById('criminalMessage').textContent = '🔴 أنت المجرم المطلوب! لا يمكنك الانضمام لأي فريق 🔴';
                    document.getElementById('criminalMessage').style.color = '#ffeb3b';
                } else {
                    document.getElementById('criminalMessage').textContent = `${gameState.criminal} هو المجرم المطلوب - لا يمكنه الانضمام لأي فريق`;
                    document.getElementById('criminalMessage').style.color = 'white';
                }
            } else {
                criminalName.textContent = 'لم يتم اختيار المجرم بعد';
                document.getElementById('criminalMessage').textContent = 'سيتم اختيار المجرم عشوائياً من اللاعبين';
            }

            // --- إضافة فحص لضمان وجود كائن الفرق قبل محاولة عرضه ---
            if (gameState.teams) {
                // Update red team display
                let redHTML = '<div style="margin-top: 15px;">';
                redHTML += '<h4 style="color: #dc3545; margin-bottom: 10px;">المحققون:</h4>';
                // --- FIX: Ensure detectives array exists before iterating ---
                if (gameState.teams.red && gameState.teams.red.detectives && gameState.teams.red.detectives.length > 0) {
                    gameState.teams.red.detectives.forEach(detective => {
                        redHTML += `<div style="background: #f8f9fa; padding: 8px; margin: 5px 0; border-radius: 5px; border-right: 3px solid #dc3545;">👮 ${detective}</div>`;
                    });
                } else {
                    redHTML += '<div style="color: #666; font-style: italic;">لا يوجد محققون</div>';
                }
                
                redHTML += '<h4 style="color: #dc3545; margin: 15px 0 10px 0;">شاهد العيان:</h4>';
                if (gameState.teams.red && gameState.teams.red.witness) {
                    redHTML += `<div style="background: #f8f9fa; padding: 8px; margin: 5px 0; border-radius: 5px; border-right: 3px solid #dc3545;">👁️ ${gameState.teams.red.witness}</div>`;
                } else {
                    redHTML += '<div style="color: #666; font-style: italic;">غير محدد</div>';
                }
                redHTML += '</div>';
                redMembers.innerHTML = redHTML;

                // Update blue team display
                let blueHTML = '<div style="margin-top: 15px;">';
                blueHTML += '<h4 style="color: #007bff; margin-bottom: 10px;">المحققون:</h4>';
                // --- FIX: Ensure detectives array exists before iterating ---
                if (gameState.teams.blue && gameState.teams.blue.detectives && gameState.teams.blue.detectives.length > 0) {
                    gameState.teams.blue.detectives.forEach(detective => {
                        blueHTML += `<div style="background: #f8f9fa; padding: 8px; margin: 5px 0; border-radius: 5px; border-right: 3px solid #007bff;">👮 ${detective}</div>`;
                    });
                } else {
                    blueHTML += '<div style="color: #666; font-style: italic;">لا يوجد محققون</div>';
                }
                
                blueHTML += '<h4 style="color: #007bff; margin: 15px 0 10px 0;">شاهد العيان:</h4>';
                if (gameState.teams.blue && gameState.teams.blue.witness) {
                    blueHTML += `<div style="background: #f8f9fa; padding: 8px; margin: 5px 0; border-radius: 5px; border-right: 3px solid #007bff;">👁️ ${gameState.teams.blue.witness}</div>`;
                } else {
                    blueHTML += '<div style="color: #666; font-style: italic;">غير محدد</div>';
                }
                blueHTML += '</div>';
                blueMembers.innerHTML = blueHTML;
                
                // Show start game button for host when all roles are filled
                if (currentPlayer && currentPlayer.isHost) {
                    const hasAllRoles = gameState.criminal && 
                                      gameState.teams.red.witness && 
                                      gameState.teams.blue.witness &&
                                      ((gameState.teams.red.detectives && gameState.teams.red.detectives.length > 0) || (gameState.teams.blue.detectives && gameState.teams.blue.detectives.length > 0));
                    
                    document.getElementById('startGameBtn2').style.display = hasAllRoles ? 'block' : 'none';
                }
                
                // Update role button styles based on current player selection
                document.querySelectorAll('.role-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                // Disable buttons for criminal
                if (currentPlayer && gameState.criminal === currentPlayer.name) {
                    document.querySelectorAll('.role-btn').forEach(btn => {
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                        btn.style.cursor = 'not-allowed';
                    });
                } else {
                    // Enable buttons for non-criminals and highlight current selection
                    document.querySelectorAll('.role-btn').forEach(btn => {
                        btn.disabled = false;
                        btn.style.opacity = '1';
                        btn.style.cursor = 'pointer';
                    });
                    
                    // Highlight current player's role
                    if (gameState.teams.red && gameState.teams.red.detectives && gameState.teams.red.detectives.includes(currentPlayer.name)) {
                        document.querySelector('[data-team="red"][data-role="detective"]').classList.add('selected');
                    } else if (gameState.teams.red && gameState.teams.red.witness === currentPlayer.name) {
                        document.querySelector('[data-team="red"][data-role="witness"]').classList.add('selected');
                    } else if (gameState.teams.blue && gameState.teams.blue.detectives && gameState.teams.blue.detectives.includes(currentPlayer.name)) {
                        document.querySelector('[data-team="blue"][data-role="detective"]').classList.add('selected');
                    } else if (gameState.teams.blue && gameState.teams.blue.witness === currentPlayer.name) {
                        document.querySelector('[data-team="blue"][data-role="witness"]').classList.add('selected');
                    }
                }
            }
        }

        function showGameScreen() {
            document.getElementById('teamScreen').classList.add('hidden');
            document.getElementById('criminalSelectionScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            updateTurnDisplay();
            createCriminalsGrid();
            updateTeamsDisplayForGame();
            updateCriminalControls();
            
            if (gameState.currentTeam === 'red') {
                document.body.classList.add('red-turn');
                document.body.classList.remove('blue-turn');
            } else {
                document.body.classList.add('blue-turn');
                document.body.classList.remove('red-turn');
            }
        }

        function updateTurnDisplay() {
            const turnIndicator = document.getElementById('turnIndicator');
            const selectionCount = document.getElementById('selectionCount');
            
            turnIndicator.textContent = `دور الفريق ${gameState.currentTeam === 'red' ? 'الأحمر' : 'الأزرق'}`;
            selectionCount.textContent = `اختر ${gameState.maxSelections} مشتبه بهم`;
        }

        function createCriminalsGrid() {
            const grid = document.getElementById('criminalsGrid');
            grid.innerHTML = '';
            
            criminals.forEach((name, index) => {
                const card = document.createElement('div');
                card.className = 'criminal-card';
                card.dataset.index = index;
                
                const isWitness = gameState.teams[gameState.currentTeam] && gameState.teams[gameState.currentTeam].witness === currentPlayer.name;
                if (isWitness && index === gameState.targetCriminal) {
                    card.classList.add('target');
                }
                
                card.innerHTML = `
                    <button class="select-btn" onclick="selectCriminal(${index})">👆</button>
                    <div class="criminal-image">👤</div>
                    <div class="criminal-name">${name}</div>
                    <div class="voters-list" id="voters-${index}"></div>
                `;
                
                card.addEventListener('click', (e) => {
                    if (e.target.classList.contains('select-btn')) return;
                    selectCriminal(index);
                });
                
                grid.appendChild(card);
            });
        }
        
        function selectCriminal(index) {
            // Check if the player is a detective in the current team
            if (!gameState.teams[gameState.currentTeam] || !gameState.teams[gameState.currentTeam].detectives.includes(currentPlayer.name)) {
                console.error("فقط المحققون يمكنهم الاختيار!");
                return;
            }

            database.ref('rooms/' + currentRoom + '/gameState/selectedCriminals').once('value').then(selectedCriminalsSnapshot => {
                let selectedCriminals = selectedCriminalsSnapshot.val() || [];
                const card = document.querySelector(`#criminalsGrid [data-index="${index}"]`);
                const isSelected = selectedCriminals.includes(index);

                if (isSelected) {
                    selectedCriminals = selectedCriminals.filter(i => i !== index);
                } else {
                    if (selectedCriminals.length >= gameState.maxSelections) {
                        console.error(`يمكنك اختيار ${gameState.maxSelections} مشتبه بهم فقط`);
                        return;
                    }
                    selectedCriminals.push(index);
                }

                database.ref('rooms/' + currentRoom + '/gameState/selectedCriminals').set(selectedCriminals).catch(error => {
                    console.error("خطأ في اختيار المجرم:", error);
                });
            });
        }
        
        function updateTeamsDisplayForGame() {
            const redDisplay = document.getElementById('redTeamDisplay');
            const blueDisplay = document.getElementById('blueTeamDisplay');
            
            // Check for team existence before updating
            if (gameState.teams && gameState.teams.red) {
                redDisplay.innerHTML = `
                    <p><strong>المحققون:</strong> ${gameState.teams.red.detectives.join(', ')}</p>
                    <p><strong>شاهد العيان:</strong> ${gameState.teams.red.witness || 'غير محدد'}</p>
                `;
            }

            if (gameState.teams && gameState.teams.blue) {
                blueDisplay.innerHTML = `
                    <p><strong>المحققون:</strong> ${gameState.teams.blue.detectives.join(', ')}</p>
                    <p><strong>شاهد العيان:</strong> ${gameState.teams.blue.witness || 'غير محدد'}</p>
                `;
            }
        }

        function finishTurn() {
            if (gameState.selectedCriminals.length !== gameState.maxSelections) {
                console.error(`يجب اختيار ${gameState.maxSelections} مشتبه بهم`);
                return;
            }
            
            database.ref('rooms/' + currentRoom + '/gameState').once('value').then(gameStateSnapshot => {
                const currentGameState = gameStateSnapshot.val() || {};
                const newGameState = {
                    ...currentGameState,
                    phase: 'witness',
                    selectedCriminals: currentGameState.selectedCriminals
                };
                
                database.ref('rooms/' + currentRoom + '/gameState').set(newGameState).catch(error => {
                    console.error("خطأ في إنهاء الدور:", error);
                });
            });
        }

        function showWitnessControls() {
            const witnessControls = document.getElementById('witnessControls');
            const isCurrentWitness = gameState.teams[gameState.currentTeam] && gameState.teams[gameState.currentTeam].witness === currentPlayer.name;
            
            if (isCurrentWitness) {
                witnessControls.classList.remove('hidden');
            } else {
                witnessControls.classList.add('hidden');
            }
        }

        function witnessResponse(isIncluded) {
            if (!gameState.teams[gameState.currentTeam] || gameState.teams[gameState.currentTeam].witness !== currentPlayer.name) return;
            
            database.ref('rooms/' + currentRoom + '/gameState').once('value').then(gameStateSnapshot => {
                const currentGameState = gameStateSnapshot.val() || {};
                const newGameState = { ...currentGameState };
                let winner = null;
                
                if (isIncluded) {
                    newGameState.maxSelections = Math.max(1, newGameState.maxSelections - 1);
                } else {
                    // Switch to the other team for the next turn.
                    newGameState.currentTeam = newGameState.currentTeam === 'red' ? 'blue' : 'red';
                }

                if (newGameState.maxSelections === 1 && isIncluded) {
                    if (newGameState.selectedCriminals.includes(newGameState.targetCriminal)) {
                        winner = newGameState.currentTeam;
                    } else {
                        winner = 'criminal';
                    }
                } else if (newGameState.maxSelections === 1 && !isIncluded) {
                    winner = 'criminal';
                }

                if (winner) {
                    newGameState.phase = 'victory';
                    newGameState.winner = winner;
                } else {
                    newGameState.phase = 'playing';
                }

                newGameState.selectedCriminals = [];
                
                database.ref('rooms/' + currentRoom + '/gameState').set(newGameState).catch(error => {
                    console.error("خطأ في استجابة الشاهد:", error);
                });
            });
        }

        function showVictoryScreen() {
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('victoryScreen').classList.remove('hidden');
            
            const winningTeamSpan = document.getElementById('winningTeam');
            const victoryScreenContent = document.querySelector('#victoryScreen .victory-screen');
            
            if (gameState.winner === 'criminal') {
                victoryScreenContent.innerHTML = `
                    <h2>🔴 فوز المجرم! 🔴</h2>
                    <div class="certificate" style="background: linear-gradient(45deg, #dc3545, #c82333);">
                        <h3>المجرم ${gameState.criminal} هرب بنجاح!</h3>
                        <p>لم تتمكن الفرق من العثور على المجرم المطلوب</p>
                        <p>المجرم كان مختبئاً في: ${criminals[gameState.targetCriminal]}</p>
                    </div>
                    <button class="btn btn-success" onclick="newGame()">لعبة جديدة</button>
                    <button class="btn btn-danger" onclick="leaveRoom()">مغادرة الغرفة</button>
                `;
            } else {
                winningTeamSpan.textContent = gameState.winner === 'red' ? 'الأحمر' : 'الأزرق';
                victoryScreenContent.innerHTML = `
                    <h2>🎉 تهانينا! 🎉</h2>
                    <div class="certificate">
                        <h3>شهادة تقدير من المحكمة العليا</h3>
                        <p>يُشهد بأن فريق <span id="winningTeamText"></span> قد نجح في القبض على المجرم المطلوب</p>
                        <p>وأظهر مهارات تحقيقية متميزة</p>
                    </div>
                    <button class="btn btn-success" onclick="newGame()">لعبة جديدة</button>
                    <button class="btn btn-danger" onclick="leaveRoom()">مغادرة الغرفة</button>
                `;
                document.getElementById('winningTeamText').textContent = gameState.winner === 'red' ? 'الأحمر' : 'الأزرق';
            }
            
            document.body.classList.remove('red-turn', 'blue-turn');
        }

        function newGame() {
            if (!currentPlayer.isHost) {
                console.error('فقط المضيف يمكنه بدء لعبة جديدة');
                return;
            }

            const initialGameState = {
                phase: 'teams',
                currentTeam: 'red',
                round: 1,
                maxSelections: 5,
                selectedCriminals: [],
                targetCriminal: null,
                criminal: null,
                criminalPosition: null,
                criminalMoves: 2,
                teams: {
                    red: { detectives: [], witness: null },
                    blue: { detectives: [], witness: null }
                }
            };
            
            database.ref('rooms/' + currentRoom + '/gameState').set(initialGameState).then(() => {
                 // Reset all players to not ready
                database.ref('rooms/' + currentRoom + '/players').once('value').then((snapshot) => {
                    const players = snapshot.val();
                    if (players) {
                        Object.keys(players).forEach(playerName => {
                            database.ref('rooms/' + currentRoom + '/players/' + playerName + '/ready').set(false);
                        });
                    }
                });
            }).catch(error => {
                console.error("خطأ في إعادة تعيين حالة اللعبة:", error);
            });
        }

        function leaveRoom() {
            if (currentRoom && currentPlayer) {
                database.ref('rooms/' + currentRoom + '/players/' + currentPlayer.name).remove().then(() => {
                    currentRoom = null;
                    currentPlayer = null;
                    document.querySelectorAll('.container > div').forEach(div => div.classList.add('hidden'));
                    document.getElementById('welcomeScreen').classList.remove('hidden');
                    document.body.classList.remove('red-turn', 'blue-turn');
                }).catch(error => {
                    console.error("خطأ في مغادرة الغرفة:", error);
                });
            }
        }
        
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const roomCode = urlParams.get('room');
            if (roomCode) {
                document.getElementById('roomCode').value = roomCode;
            }
        });
    </script>
</body>
</html>
